import pygame
import math
import random
from pathfinding.core.grid import Grid
from pathfinding.finder.a_star import AStarFinder
pygame.init() #configuración básica de la pantalla de juego
global alto, ancho
ancho = 1280
alto = 720

pantalla_de_juego = pygame.display.set_mode([ancho, alto])#establece la pantalla de juego y su dimensiones basado en ancho y alto
timepo = pygame.time.Clock()
fps = 60
font = pygame.font.Font('freesansbold.ttf', 20)
level = [
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
[0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0],
[0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 4, 0, 0, 0, 0, 4, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 4, 0, 0, 0, 0, 4, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 4, 5, 4, 4, 4, 4, 5, 4, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0],
[1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1],
[0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 4, 0],
[0, 4, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 4, 0],
[0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0],
[0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0],
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
]
color = 'blue'
PI = math.pi
imagenes_jugador_principal = []
for i in range(1, 3):#Toma dos imagenes, se reeedimensionan y esto crea la ilusion de movimiento en mi personaje
    imagenes_jugador_principal.append(pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\\Documents\\Phyton\\Proyecto Pacman\\imagenes_jugador_principal\\{i}.jpg"), (20, 20)))
rojo_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\rojo.jpg"), (20, 20))
rosa_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\rosa.jpg"), (20, 20))
azul_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\azul.jpg"), (20, 20))
naranja_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\naranja.jpg"), (20, 20))
asustado_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\asustado.jpg"), (20, 20))
muerto_img = pygame.transform.scale(pygame.image.load(f"C:\\Users\\equid\\Documents\\Phyton\\Proyecto Pacman\\Fantasmas Img\\muerto.jpg"), (20, 20))
pos_x = 200 #Posiciones donde va a inicar pacman
pos_y = 180
direccion = 0
#Posiciones de los fantasmas
rojo_x = 900
rojo_y = 350
rojo_direccion = 0
azul_x = 800
azul_y = 350
azul_direccion = 2
rosa_x = 850
rosa_y = 350
rosa_direccion = 2
naranja_x = 700
naranja_y = 350
naranja_direccion = 2
contador = 0
destellos = False
turns_allowed = [False, False, False, False]
direccion_command = 0
jugador_velocidad = 2
score = 0
powerup = False
power_contador = 0
come_fantasmas = [False, False, False, False]
targets = [(pos_x, pos_y), (pos_x, pos_y), (pos_x, pos_y), (pos_x, pos_y)]
rojo_muerto = False
azul_muerto = False
naranja_muerto = False
rosa_muerto = False
blinky_box = False
inky_box = False
clyde_box = False
pinky_box = False
moving = False
fantasmas_velocidad = [2, 2, 2, 2]
startup_counter = 0
lives = 3
game_over = False
gana_juego = False


class Ghost():# Estas son las caracteristicas que comparten los fantasmas;
    #x_coord y y_coord son las coordenadas de los fantasmas, objetivo es a quien buscan, img sus imagenes
    #direcc su direccion, box es para saber si se encuentran en la parte de la caja, id es para identificar a cada fantasma por separado
    def __init__(self, x_coord, y_coord, objetivo, velocidad, img, direcc, muerto, box, id,x_pos, y_pos, max_pasos):
        self.x_pos = x_coord
        self.y_pos = y_coord
        self.center_x = self.x_pos + 10 # Para ajustar el centro de la imagen
        self.center_y = self.y_pos + 10
        self.objetivo = objetivo
        self.velocidad = velocidad
        self.img = img
        self.direccion = direcc
        self.muerto = muerto
        self.in_box = box
        self.id = id
        self.rect = self.dibuja() #Hitbox de los fantasmas para revisar en colisiones
        self.turns = [False,False,False,False]
        self.x_pos = x_pos
        self.y_pos = y_pos
        self.max_pasos = max_pasos
        self.contador_pasos = 0
        self.direccion_actual = random.choice([0, 1, 2, 3])


    def dibuja(self):#Condiciones de los estados de los fantasmas
        #Fantasmas en su estado normal
        if (not powerup and not self.muerto) or (come_fantasmas[self.id] and powerup and not self.muerto):
            pantalla_de_juego.blit(self.img, (self.x_pos, self.y_pos))
        #Fantasmas en estado asustado sino esta muertos    
        elif powerup and not self.muerto and not come_fantasmas[self.id]:
            pantalla_de_juego.blit(asustado_img, (self.x_pos, self.y_pos))
        #Fantasmas muertos    
        else:
            pantalla_de_juego.blit(muerto_img, (self.x_pos, self.y_pos))
        fantasma_rect = pygame.rect.Rect((self.center_x - 18, self.center_y - 18), (36, 36))#hitbox para colisiones con los fantasmas, es un simple rectangulo para verificar las colisiones
        return fantasma_rect

    def revisar_colisiones(self, x_coord, y_coord):
        # Verificar si la posición siguiente está dentro de los límites de la matriz
        if 0 <= x_coord < len(level[0]) and 0 <= y_coord < len(level):
            # Verificar si el próximo movimiento es permitido (casillas diferentes de 0)
            if level[y_coord][x_coord] != 0:
                return True
        return False
           
    def move_naranja(self):
        global naranja_direccion

        if self.contador_pasos < 20:
            # Mover en la dirección actual
            self.contador_pasos += 1
            nueva_x, nueva_y = self.x_pos, self.y_pos

            if self.direccion_actual == 0:  # Mover hacia arriba
                nueva_y -= 1
            elif self.direccion_actual == 1:  # Mover hacia abajo
                nueva_y += 1
            elif self.direccion_actual == 2:  # Mover hacia la izquierda
                nueva_x -= 1
            elif self.direccion_actual == 3:  # Mover hacia la derecha
                nueva_x += 1

            # Verificar si las nuevas coordenadas son válidas (no colisionan con obstáculos)
            if not self.revisar_colisiones(nueva_x, nueva_y):
                self.x_pos, self.y_pos = nueva_x, nueva_y
        else:
            # Cambiar de dirección después de 20 pasos
            self.contador_pasos = 0
            posibles_direcciones = [0, 1, 2, 3]
            posibles_direcciones.remove(self.direccion_actual)
            nueva_direccion = random.choice(posibles_direcciones)

            # Calcular las nuevas coordenadas según la nueva dirección
            nueva_x, nueva_y = self.x_pos, self.y_pos

            if nueva_direccion == 0:  # Mover hacia arriba
                nueva_y -= 1
            elif nueva_direccion == 1:  # Mover hacia abajo
                nueva_y += 1
            elif nueva_direccion == 2:  # Mover hacia la izquierda
                nueva_x -= 1
            elif nueva_direccion == 3:  # Mover hacia la derecha
                nueva_x += 1

            # Verificar si las nuevas coordenadas son válidas (no colisionan con obstáculos)
            if not self.revisar_colisiones(nueva_x, nueva_y):
                self.x_pos, self.y_pos = nueva_x, nueva_y
                self.direccion_actual = nueva_direccion

        return self.x_pos, self.y_pos

    # def move_rojo(self):
        

    # def move_azul(self):
        
        

    # def move_rosa(self):
       


def draw_misc():
    score_text = font.render(f'Puntaje: {score}', True, 'white')#Texto de puntaje
    pantalla_de_juego.blit(score_text, (10, 920))
    if powerup: # Dibuja el indicador de la potencia si está activo
        pygame.draw.circle(pantalla_de_juego, 'blue', (140, 930), 15)
    for i in range(lives):# Dibuja los íconos de vidas
        pantalla_de_juego.blit(pygame.transform.scale(imagenes_jugador_principal[0], (30, 30)), (650 + i * 40, 915))
    if game_over: # Dibuja la pantalla de Game Over si es necesario
        pygame.draw.rect(pantalla_de_juego, 'white', [50, 200, 800, 300],0, 10)
        pygame.draw.rect(pantalla_de_juego, 'dark gray', [70, 220, 760, 260], 0, 10)
        gameover_text = font.render('Fin del juego! Barra espaciadora para reiniciar!', True, 'red')
        pantalla_de_juego.blit(gameover_text, (100, 300))
    if gana_juego: # Dibuja la pantalla de Victoria si es necesario
        pygame.draw.rect(pantalla_de_juego, 'white', [50, 200, 800, 300],0, 10)
        pygame.draw.rect(pantalla_de_juego, 'dark gray', [70, 220, 760, 260], 0, 10)
        gameover_text = font.render('Ganaste! Barra espaciadora para reiniciar!', True, 'green')
        pantalla_de_juego.blit(gameover_text, (100, 300))
        
def revisar_collisions(scor, power, power_contador, come_fantasmas):
    # Calcular las dimensiones de las celdas en la matriz del nivel
    num1 = (alto - 50) // 32
    num2 = ancho // 30
    # Verificar si la posición de Pacman está dentro de los límites laterales
    if 0 < pos_x < 1280:
        # Verificar si Pacman ha alcanzado un punto blanco (valor 1) en la matriz del nivel
        if level[center_y // num1][center_x // num2] == 1:
            # Actualizar la posición en la matriz del nivel a un valor diferente (por ejemplo, 4) para indicar que el punto ha sido comido
            level[center_y // num1][center_x // num2] = 4
            # Incrementar la puntuación
            scor += 10
        if level[center_y // num1][center_x // num2] == 2:# Verificar si Pacman ha alcanzado una cápsula de poder (valor 2) en la matriz del nivel
            level[center_y // num1][center_x // num2] = 4  # Actualizar la posición en la matriz del nivel a un valor diferente (por ejemplo, 4) para indicar que la cápsula ha sido comido
            # Incrementar la puntuación
            scor += 50
             # Activar el poder temporal de comer fantasmas
            power = True
            # Reiniciar el contador del poder
            power_contador = 0
            # Restablecer el estado de los fantasmas comidos
            come_fantasmas = [False, False, False, False]
    return scor, power, power_contador, come_fantasmas # Devolver los valores actualizados

def dibujar_mapa():
    num1 = ((alto - 50) // 32)
    num2 = (ancho // 30)
    for i in range (len(level)): # Es para interactuar con cada fila de la matriz
        for j in range (len(level[i])):
            if level[i][j] == 1:
                #En esta parte se dibuja en la matriz los puntos blancos que come pacman definiendo color, posicion y tamaño
                pygame.draw.circle(pantalla_de_juego, 'white', (j * num2 + (0.5 * num2), i * num1 + (0.5 * num1)), 3)
            if level[i][j] == 0:
                # Esto dibuja un rectangulo azul en el valor 0, definido por los limites num1 y num2 
                pygame.draw.rect(pantalla_de_juego, 'blue', pygame.Rect(j * num2, i * num1, num2, num1))    
            if level[i][j] == 2 and not destellos:
                #En esta parte se dibuja en la matriz los puntos blancos que le dan velocidad (capsulas de poder)
                pygame.draw.circle(pantalla_de_juego, 'white', (j * num2 + (0.5 * num2), i * num1 + (0.5 * num1)), 5)
            if level[i][j] == 3:
                #En esta parte se dibuja en la matriz las frutas 
                pygame.draw.circle(pantalla_de_juego, 'red', (j * num2 + (0.5 * num2), i * num1 + (0.5 * num1)), 5)
            if level[i][j] == 4:
                #En esta parte se dibuja en la matriz las frutas 
                pygame.draw.circle(pantalla_de_juego, 'black', (j * num2 + (0.5 * num2), i * num1 + (0.5 * num1)), 5)

def revisar_posiciones(centrox, centroy):
    giros = [False, False, False, False]
    num1 = (alto - 50) // 32
    num2 = (ancho // 30)
    row = centroy // num1
    col = centrox // num2
    

    if 0 <= row < len(level) and 0 <= col < len(level[row]):
        # Verificar giros basados en las casillas adyacentes
        if level[row][col] != 0:
            giros[0] = True  # Puede moverse a la derecha
        if level[row][col - 1] != 0:
            giros[1] = True  # Puede moverse a la izquierda
        if level[row - 1][col] != 0:
            giros[2] = True  # Puede moverse hacia arriba
        if level[row + 1][col] != 0:
            giros[3] = True  # Puede moverse hacia abajo

    return giros

run = True
while run:
    timepo.tick(fps) # Controla la velocidad del bucle principal del juego.
    if contador < 19: # Controla la animación de destellos del jugador
        contador += 1
        if contador > 3:
            destellos = False
    else:
        contador = 0
        destellos = True
    if powerup and power_contador < 600: # Controla la duración del poder especial(come fantasmas) y su reinicio
        power_contador += 1
    elif powerup and power_contador >= 600:
        power_contador = 0
        powerup = False
        come_fantasmas = [False, False, False, False]
    if startup_counter < 180 and not game_over and not gana_juego: # Controla el inicio del juego y la animación inicial
        moving = False
        startup_counter += 1
    else:
        moving = True

    pantalla_de_juego.fill('black') # Llena la pantalla con un color negro.
    dibujar_mapa() # Dibuja el mapa del juego.
    center_x = pos_x + 10
    center_y = pos_y + 10
    
    if powerup:
        fantasmas_velocidad = [1, 1, 1, 1] # Velocidades de los fantasmas durante el poder especial
    else:
        fantasmas_velocidad = [2, 2, 2, 2] # Velocidades normales de los fantasmas.
    if come_fantasmas[0]:
        fantasmas_velocidad[0] = 2 # Velocidad del fantasma rojo cuando es comido.
    if come_fantasmas[1]:
        fantasmas_velocidad[1] = 2 # Velocidad del fantasma azul cuando es comido.
    if come_fantasmas[2]:
        fantasmas_velocidad[2] = 2 # Velocidad del fantasma rosa cuando es comido.
    if come_fantasmas[3]:
        fantasmas_velocidad[3] = 2 # Velocidad del fantasma naranja cuando es comido.
    if rojo_muerto:
        fantasmas_velocidad[0] = 4 # Velocidad del fantasma rojo cuando está muerto.
    if azul_muerto:
        fantasmas_velocidad[1] = 4 # Velocidad del fantasma azul cuando está muerto.
    if rosa_muerto:
        fantasmas_velocidad[2] = 4 # Velocidad del fantasma rosa cuando está muerto.
    if naranja_muerto:
        fantasmas_velocidad[3] = 4 # Velocidad del fantasma naranja cuando está muerto.

    gana_juego = True # Ciclo for para ganar
    for i in range(len(level)):
        if 1 in level[i] or 2 in level[i]:
            gana_juego = False
    # Dibuja el círculo del jugador en pantalla, este se utiliza para simplifacr aspectos como las colisiones
    player_circle = pygame.draw.circle(pantalla_de_juego, 'black', (center_x, center_y), 10, 1)
    dibuja_jugador() # Dibuja al jugador en pantalla.
    #Inicializa a los fantasmas con sus respectivas posiciones, velocidades y estados.
    rojo = Ghost(rojo_x, rojo_y, targets[0], fantasmas_velocidad[0], rojo_img, rojo_direccion, rojo_muerto,
                   blinky_box, 0)
    azul = Ghost(azul_x, azul_y, targets[1], fantasmas_velocidad[1], azul_img, azul_direccion, azul_muerto,
                 inky_box, 1)
    rosa = Ghost(rosa_x, rosa_y, targets[2], fantasmas_velocidad[2], rosa_img, rosa_direccion, rosa_muerto,
                  pinky_box, 2)
    naranja = Ghost(naranja_x, naranja_y, targets[3], fantasmas_velocidad[3], naranja_img, naranja_direccion, naranja_muerto,
                  clyde_box, 3)
    draw_misc() #Dbuja funcion de los cuadros emergentes y el puntaje, esta se define arriba en el código
    #targets = get_targets(rojo_x, rojo_y, azul_x, azul_y, rosa_x, rosa_y, naranja_x, naranja_y)

    turns_allowed = revisar_posiciones(center_x, center_y)
    if moving:# Verifica las direcciones permitidas para el jugador basándose en la posición central del jugador.
        pos_x, pos_y = move_player(pos_x, pos_y)
        
        naranja_x, naranja_y = naranja.move_naranja()
    #Verifica colisiones del jugador y actualiza el puntaje, el estado de la "powerup" y el estado de los fantasmas comidos.    
    score, powerup, power_contador, come_fantasmas = revisar_collisions(score, powerup, power_contador, come_fantasmas)
    if not powerup:# Verifica colisiones del jugador con fantasmas y actualiza el estado del juego y puntaje en consecuencia.
        if (player_circle.colliderect(rojo.rect) and not rojo.muerto) or \
                (player_circle.colliderect(azul.rect) and not azul.muerto) or \
                (player_circle.colliderect(rosa.rect) and not rosa.muerto) or \
                (player_circle.colliderect(naranja.rect) and not naranja.muerto):
            if lives > 0: # Reduce el número de vidas y reinicia la posición del jugador y fantasmas.
                lives -= 1
                startup_counter = 0
                powerup = False
                power_contador = 0
                pos_x = 200 # Reinicia la posición del jugador y los fantasmas
                pos_y = 180
                direccion = 0
                direccion_command = 0
                rojo_x = 900
                rojo_y = 350
                rojo_direccion = 0
                azul_x = 800
                azul_y = 350
                azul_direccion = 2
                rosa_x = 850
                rosa_y = 350
                rosa_direccion = 2
                naranja_x = 700
                naranja_y = 350
                naranja_direccion = 2
                come_fantasmas = [False, False, False, False]
                rojo_muerto = False
                azul_muerto = False
                naranja_muerto = False
                rosa_muerto = False
            else:# Si no hay vidas restantes, marca el juego como terminado.
                game_over = True
                moving = False
                startup_counter = 0
    if powerup and player_circle.colliderect(rojo.rect) and come_fantasmas[0] and not rojo.muerto:# Verifica si el jugador tiene un powerup activo, ha colisionado con un fantasma rojo y el rojo no está muerto.
        if lives > 0: # Verifica si hay vidas restantes para el jugador.
            powerup = False # Desactiva el powerup, reduce el contador, y disminuye las vidas.
            power_contador = 0
            lives -= 1 
            startup_counter = 0
            pos_x = 200 # Reinicia la posición del jugador y los fantasmas.
            pos_y = 180
            direccion = 0
            direccion_command = 0
            rojo_x = 900
            rojo_y = 350
            rojo_direccion = 0
            azul_x = 800
            azul_y = 350
            azul_direccion = 2
            rosa_x = 850
            rosa_y = 350
            rosa_direccion = 2
            naranja_x = 700
            naranja_y = 350
            naranja_direccion = 2
            come_fantasmas = [False, False, False, False]# Reinicia el estado de los fantasmas.
            rojo_muerto = False
            azul_muerto = False
            naranja_muerto = False
            rosa_muerto = False
        else:
            game_over = True # Si no hay vidas restantes, marca el juego como terminado.
            moving = False
            startup_counter = 0
    if powerup and player_circle.colliderect(azul.rect) and come_fantasmas[1] and not azul.muerto:# Verifica si el jugador tiene un powerup activo, ha colisionado con un fantasma azul y el azul no está muerto.
        if lives > 0:
            powerup = False# Desactiva el powerup, reduce el contador, y disminuye las vidas.
            power_contador = 0
            lives -= 1
            startup_counter = 0 # Reinicia la posición del jugador y los fantasmas.
            pos_x = 200
            pos_y = 180
            direccion = 0
            direccion_command = 0
            rojo_x = 900
            rojo_y = 350
            rojo_direccion = 0
            azul_x = 800
            azul_y = 350
            azul_direccion = 2
            rosa_x = 850
            rosa_y = 350
            rosa_direccion = 2
            naranja_x = 700
            naranja_y = 350
            naranja_direccion = 2
            come_fantasmas = [False, False, False, False]# Reinicia el estado de los fantasmas.
            rojo_muerto = False
            azul_muerto = False
            naranja_muerto = False
            rosa_muerto = False
        else:# Si no hay vidas restantes, marca el juego como terminado.
            game_over = True
            moving = False
            startup_counter = 0
    if powerup and player_circle.colliderect(rosa.rect) and come_fantasmas[2] and not rosa.muerto:# Verifica si el jugador tiene un powerup activo, ha colisionado con un fantasma rosa y el rosa no está muerto.
        if lives > 0:# Verifica si hay vidas restantes para el jugador.
            powerup = False # Desactiva el powerup, reduce el contador, y disminuye las vidas.
            power_contador = 0
            lives -= 1
            startup_counter = 0
            pos_x = 200# Reinicia la posición del jugador y los fantasmas
            pos_y = 180
            direccion = 0
            direccion_command = 0
            rojo_x = 900
            rojo_y = 350
            rojo_direccion = 0
            azul_x = 800
            azul_y = 350
            azul_direccion = 2
            rosa_x = 850
            rosa_y = 350
            rosa_direccion = 2
            naranja_x = 800
            naranja_y = 350
            naranja_direccion = 2
            come_fantasmas = [False, False, False, False]# Reinicia el estado de los fantasmas.
            rojo_muerto = False
            azul_muerto = False
            naranja_muerto = False
            rosa_muerto = False
        else:# Si no hay vidas restantes, marca el juego como terminado.
            game_over = True
            moving = False
            startup_counter = 0
    if powerup and player_circle.colliderect(naranja.rect) and come_fantasmas[3] and not naranja.muerto:# Verifica si el jugador tiene un powerup activo, ha colisionado con un fantasma naranja y el naranja no está muerto.
        if lives > 0:
            powerup = False# Desactiva el powerup, reduce el contador, y disminuye las vidas.
            power_contador = 0
            lives -= 1
            startup_counter = 0
            pos_x = 200 # Reinicia la posición del jugador y los fantasmas.
            pos_y = 180
            direccion = 0
            direccion_command = 0
            rojo_x = 900
            rojo_y = 350
            rojo_direccion = 0
            azul_x = 800
            azul_y = 350
            azul_direccion = 2
            rosa_x = 850
            rosa_y = 350
            rosa_direccion = 2
            naranja_x = 700
            naranja_y = 350
            naranja_direccion = 2
            come_fantasmas = [False, False, False, False]# Reinicia el estado de los fantasmas.
            rojo_muerto = False
            azul_muerto = False
            naranja_muerto = False
            rosa_muerto = False
        else:# Si no hay vidas restantes, marca el juego como terminado.
            game_over = True
            moving = False
            startup_counter = 0
    if powerup and player_circle.colliderect(rojo.rect) and not rojo.muerto and not come_fantasmas[0]:# Verifica si el jugador tiene un powerup activo y ha colisionado con un fantasma rojo que aún no ha sido comido.
        rojo_muerto = True # Marca al fantasma rojo como muerto y comido, actualiza el puntaje según el número total de fantasmas comidos.
        come_fantasmas[0] = True
        score += (2 ** come_fantasmas.count(True)) * 100
    if powerup and player_circle.colliderect(azul.rect) and not azul.muerto and not come_fantasmas[1]:# Lo mismo pero para el fantasma azul
        azul_muerto = True
        come_fantasmas[1] = True
        score += (2 ** come_fantasmas.count(True)) * 100
    if powerup and player_circle.colliderect(rosa.rect) and not rosa.muerto and not come_fantasmas[2]:# Lo mismo pero para el fantasma rosa
        rosa_muerto = True
        come_fantasmas[2] = True
        score += (2 ** come_fantasmas.count(True)) * 100
    if powerup and player_circle.colliderect(naranja.rect) and not naranja.muerto and not come_fantasmas[3]:# Lo mismo pero para el fantasma naranja
        naranja_muerto = True
        come_fantasmas[3] = True
        score += (2 ** come_fantasmas.count(True)) * 100

    for event in pygame.event.get():
        if event.type == pygame.QUIT:    # Verifica si se ha cerrado la ventana
            run = False
        if event.type == pygame.KEYDOWN: # Verifica teclas presionadas
            if event.key == pygame.K_RIGHT:# Cambia la dirección del jugador basado en la tecla presionada
                direccion_command = 0
            if event.key == pygame.K_LEFT:
                direccion_command = 1
            if event.key == pygame.K_UP:
                direccion_command = 2
            if event.key == pygame.K_DOWN:
                direccion_command = 3
            if event.key == pygame.K_SPACE and (game_over or gana_juego):# Si se presiona la tecla espaciadora y el juego ha terminado (ya sea por pérdida o victoria), reinicia el juego.
                powerup = False # Reinicia las variables del juego
                power_contador = 0
                lives -= 1
                startup_counter = 0
                pos_x = 200
                pos_y = 180
                direccion = 0
                direccion_command = 0
                rojo_x = 900
                rojo_y = 350
                rojo_direccion = 0
                azul_x = 800
                azul_y = 350
                azul_direccion = 2
                rosa_x = 850
                rosa_y = 350
                rosa_direccion = 2
                naranja_x = 700
                naranja_y = 350
                naranja_direccion = 2
                come_fantasmas = [False, False, False, False]
                rojo_muerto = False
                azul_muerto = False
                naranja_muerto = False
                rosa_muerto = False
                score = 0
                lives = 3
                game_over = False
                gana_juego = False

        if event.type == pygame.KEYUP:
            if event.key == pygame.K_RIGHT and direccion_command == 0:
                direccion_command = direccion
            if event.key == pygame.K_LEFT and direccion_command == 1:
                direccion_command = direccion
            if event.key == pygame.K_UP and direccion_command == 2:
                direccion_command = direccion
            if event.key == pygame.K_DOWN and direccion_command == 3:
                direccion_command = direccion

    if direccion_command == 0 and turns_allowed[0]:# Verifica y actualiza la dirección del jugador basado en la dirección solicitada y si la dirección solicitada es permitida.
        direccion = 0
    if direccion_command == 1 and turns_allowed[1]:
        direccion = 1
    if direccion_command == 2 and turns_allowed[2]:
        direccion = 2
    if direccion_command == 3 and turns_allowed[3]:
        direccion = 3

    if rojo.in_box and rojo_muerto:# Verifica y ajusta el estado de los fantasmas después de salir de la caja de inicio.
        rojo_muerto = False
    if azul.in_box and azul_muerto:
        azul_muerto = False
    if rosa.in_box and rosa_muerto:
        rosa_muerto = False
    if naranja.in_box and naranja_muerto:
        naranja_muerto= False
 
    pygame.display.flip()
pygame.quit()
